<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Docent Bot</title>
    <style>
      body{
        font-family:sans-serif;
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:flex-start;
        height:100vh;
        margin:0;
        background-color:#f0f2f5;
        padding-top:20px;
        box-sizing:border-box
        }

        #container{
            width:90%;
            max-width:700px;
            text-align:center
            }
        #status{
            font-size:1.2em;
            color:#333;
            margin-bottom:20px;
            background-color:#e9ecef;
            padding:10px 20px;
            border-radius:20px;
            text-align:center;
            font-weight:700
            }

        #recordBtn,#playBtn{
            font-size:1.5em;
            padding:20px 40px;
            border-radius:50px;
            border:none;
            cursor:pointer;
            color:#fff;
            transition:background-color .3s;
            margin-bottom:20px
        }
        #recordBtn{background-color:#28a745}

        #recordBtn.recording{
            background-color:#dc3545
            }
        #recordBtn:disabled{
            background-color:#6c757d;
            cursor:not-allowed
            }
        /* âœ¨ ì¬ìƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        #playBtn { background-color: #007bff; }

        #transcript{
            text-align:left;
            width:100%;
            background-color:#fff;
            border-radius:8px;
            padding:20px;
            box-shadow:0 2px 4px rgba(0,0,0,.1);
            height:50vh;
            overflow-y:auto;
            box-sizing:border-box
            }
        .message{
            margin-bottom:12px;
            line-height:1.5
        }
        .user{
            color:#005a9c;
            font-weight:700
        }
        .ai{
            color:#444
        }
        
        .hidden{
            display:none
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>AI Docent Bot</h1>
        <div id="status">ì„œë²„ì— ì—°ê²° ì¤‘...</div>
        <button id="recordBtn" disabled>ğŸ¤ ì§ˆë¬¸ Start</button>
        <button id="playBtn" class="hidden">â–¶ï¸ ë‹µë³€ ë“£ê¸°</button> 
        <div id="transcript"></div>
    </div>
    
    <script>
    const statusDiv = document.getElementById('status');
    const recordBtn = document.getElementById('recordBtn');
    const playBtn = document.getElementById('playBtn');
    const transcriptDiv = document.getElementById('transcript');
    
    let socket;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;

    let audioContext;
    let lastReceivedAudioBlob = null; // iOSì—ì„œ ì‚¬ìš©í•  ì˜¤ë””ì˜¤ Blob

     // âœ¨ 1. iOS ê¸°ê¸°ì¸ì§€ íŒë³„í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    function isIOS() {
        return /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì›¹ì†Œì¼“ ì—°ê²° ì‹œì‘
    connectWebSocket();

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        const socketURL = `${protocol}//${host}/ws`;
        socket = new WebSocket(socketURL);

        socket.onopen = () => {
            statusDiv.textContent = "ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.";
            recordBtn.disabled = false;
            transcriptDiv.innerHTML = "<p>ì±—ë´‡ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.</p>";
        };

        // âœ¨ 2. ê¸°ê¸°ë³„ë¡œ ë¶„ê¸° ì²˜ë¦¬í•˜ëŠ” onmessage ë¡œì§
        socket.onmessage = async (event) => {
            if (event.data instanceof Blob) {
                console.log("ì„œë²„ë¡œë¶€í„° ìŒì„±(Blob) ë°ì´í„°ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.");
                
                if (isIOS()) {
                    // --- iOS ê¸°ê¸°ì¼ ê²½ìš°: 'ë‹µë³€ ë“£ê¸°' ë²„íŠ¼ í‘œì‹œ ---
                    console.log("iOS ê¸°ê¸° ê°ì§€ë¨. ì¬ìƒ ë²„íŠ¼ì„ í‘œì‹œí•©ë‹ˆë‹¤.");
                    lastReceivedAudioBlob = event.data; // Blobì„ ë‚˜ì¤‘ì— ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì €ì¥
                    
                    statusDiv.textContent = "ë‹µë³€ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤. ë“£ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
                    recordBtn.disabled = true;
                    playBtn.classList.remove('hidden');

                } else {
                    // --- PC, ì•ˆë“œë¡œì´ë“œ ë“± ë‹¤ë¥¸ ê¸°ê¸°ì¼ ê²½ìš°: ìë™ ì¬ìƒ ---
                    console.log("Non-iOS ê¸°ê¸° ê°ì§€ë¨. ìë™ ì¬ìƒí•©ë‹ˆë‹¤.");
                    const audioUrl = URL.createObjectURL(event.data);
                    const audio = new Audio(audioUrl);
                    
                    statusDiv.textContent = "ë‹µë³€ì„ ì¬ìƒí•©ë‹ˆë‹¤...";
                    recordBtn.disabled = true; // ì¬ìƒ ì¤‘ì—ëŠ” ë²„íŠ¼ ë¹„í™œì„±í™”
                    audio.play();
                    
                    // ì¬ìƒì´ ëë‚˜ë©´ ë…¹ìŒ ë²„íŠ¼ì„ ë‹¤ì‹œ í™œì„±í™”
                    audio.onended = () => {
                        console.log("ìŒì„± ì¬ìƒ ì™„ë£Œ (ìë™ì¬ìƒ)");
                        statusDiv.textContent = "ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.";
                        recordBtn.disabled = false;
                    };
                }

            } else {
                // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì²˜ë¦¬
                const message = JSON.parse(event.data);
                addMessageToTranscript(message.type, message.data);
            }
        };
        
        socket.onclose = () => { /* ì´ì „ê³¼ ë™ì¼ */ };
    }
    
    // âœ¨ 3. ì¬ìƒ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (iOSì—ì„œë§Œ ì‚¬ìš©ë¨)
    playBtn.onclick = async () => {
        if (!lastReceivedAudioBlob) return;
        if (!audioContext) { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
        if (audioContext.state === 'suspended') await audioContext.resume();

        try {
            const arrayBuffer = await lastReceivedAudioBlob.arrayBuffer();
            const decodedBuffer = await audioContext.decodeAudioData(arrayBuffer);

            const source = audioContext.createBufferSource();
            source.buffer = decodedBuffer;
            source.connect(audioContext.destination);
            source.start(0);

            statusDiv.textContent = "ë‹µë³€ì„ ì¬ìƒí•©ë‹ˆë‹¤...";
            playBtn.classList.add('hidden');

            source.onended = () => {
                console.log("ìŒì„± ì¬ìƒ ì™„ë£Œ (iOS)");
                statusDiv.textContent = "ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.";
                recordBtn.disabled = false;
            };
        } catch (e) {
            console.error("ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:", e);
            alert("ì˜¤ë””ì˜¤ ì¬ìƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            recordBtn.disabled = false;
        } finally {
            lastReceivedAudioBlob = null;
        }
    };


    // ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ì€ ëª¨ë‘ ì´ì „ ë‹µë³€ê³¼ ë™ì¼í•©ë‹ˆë‹¤.
//    async function startRecording() {
//        try {
//            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
//            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
//            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
//            mediaRecorder.onstop = () => {
//                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
//                if (socket?.readyState === WebSocket.OPEN) socket.send(audioBlob);
//                audioChunks = [];
//            };
//            mediaRecorder.start();
//            isRecording = true;
//            transcriptDiv.innerHTML = "";
//            statusDiv.textContent = "ë§ì”€í•˜ì„¸ìš”...";
//            recordBtn.textContent = "ğŸ™ï¸ ë…¹ìŒ ì¤‘ì§€";
//            recordBtn.classList.add('recording');
//            playBtn.classList.add('hidden');
//        } catch (err) { alert("ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
//   }

//    function stopRecording() {
//        if (mediaRecorder) mediaRecorder.stop();
//        isRecording = false;
//        statusDiv.textContent = "ìŒì„±ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...";
//        recordBtn.textContent = "ğŸ¤ ë…¹ìŒ ì‹œì‘";
//        recordBtn.classList.remove('recording');
//        recordBtn.disabled = true;
//    }

//    function addMessageToTranscript(sender, text) {
//        const p = document.createElement('p');
//        p.classList.add('message');
//        p.innerHTML = `<span class="${sender === 'user' ? 'user' : 'ai'}">${sender === 'user' ? 'ğŸ‘¤ ë‚˜:' : 'ğŸ¤– Gemini:'}</span> ${text}`;
//        transcriptDiv.appendChild(p);
//        transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
//    }

    recordBtn.onclick = () => { isRecording ? stopRecording() : startRecording(); };


    function addMessageToTranscript(sender, text) { const p = document.createElement('p'); p.classList.add('message'); p.innerHTML = `<span class="${sender === 'user' ? 'user' : 'ai'}">${sender === 'user' ? 'ğŸ‘¤ ë‚˜:' : 'ğŸ¤– Gemini:'}</span> ${text}`; transcriptDiv.appendChild(p); transcriptDiv.scrollTop = transcriptDiv.scrollHeight; }
    function stopRecording() { if (mediaRecorder) mediaRecorder.stop(); isRecording = false; statusDiv.textContent = "ìŒì„±ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤..."; recordBtn.textContent = "ğŸ¤ ë…¹ìŒ ì‹œì‘"; recordBtn.classList.remove('recording'); recordBtn.disabled = true; }
    async function startRecording() { if (!audioContext) { audioContext = new (window.AudioContext || window.webkitAudioContext)(); if (audioContext.state === 'suspended') await audioContext.resume(); } try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' }); mediaRecorder.ondataavailable = e => audioChunks.push(e.data); mediaRecorder.onstop = () => { const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); if (socket?.readyState === WebSocket.OPEN) socket.send(audioBlob); audioChunks = []; }; mediaRecorder.start(); isRecording = true; transcriptDiv.innerHTML = ""; statusDiv.textContent = "ë§ì”€í•˜ì„¸ìš”..."; recordBtn.textContent = "ğŸ™ï¸ ë…¹ìŒ ì¤‘ì§€"; recordBtn.classList.add('recording'); playBtn.classList.add('hidden'); } catch (err) { alert("ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); } }


</script>
</body>
</html>