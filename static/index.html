<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 음성 챗봇 (최종 안정화)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; height: 100vh; margin: 0; background-color: #f0f2f5; padding-top: 20px; box-sizing: border-box; }
        #container { width: 90%; max-width: 700px; text-align: center; }
        #status { font-size: 1.2em; color: #333; margin-bottom: 20px; background-color: #e9ecef; padding: 10px 20px; border-radius: 20px; text-align: center; font-weight: bold; }
        #recordBtn { font-size: 1.5em; padding: 20px 40px; border-radius: 50px; border: none; cursor: pointer; background-color: #28a745; color: white; transition: background-color 0.3s; margin-bottom: 20px; }
        #recordBtn.recording { background-color: #dc3545; }
        #recordBtn:disabled { background-color: #6c757d; cursor: not-allowed; }
        #transcript { text-align: left; width: 100%; background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 50vh; overflow-y: auto; box-sizing: border-box;}
        .message { margin-bottom: 12px; line-height: 1.5; }
        .user { color: #005A9C; font-weight: bold; }
        .ai { color: #444; }
    </style>
</head>
<body>
    <div id="container">
        <h1>음성 챗봇 (최종 안정화 버전)</h1>
        <div id="status">서버에 연결 중...</div>
        <button id="recordBtn" disabled>🎤 녹음 시작</button>
        <div id="transcript"><p>서버 연결을 기다립니다...</p></div>
    </div>
    <script>
        const statusDiv = document.getElementById('status');
        const recordBtn = document.getElementById('recordBtn');
        const transcriptDiv = document.getElementById('transcript');
        
        let socket;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        function connectWebSocket() {
            console.log("1. WebSocket 연결을 시도합니다...");
            
            // Render.com 배포 환경을 위한 동적 URL 생성
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const socketURL = `${protocol}//${host}/ws`;

            socket = new WebSocket(socketURL);

            socket.onopen = () => {
                console.log("2. WebSocket 연결에 성공했습니다.");
                statusDiv.textContent = "녹음 버튼을 누르고 말씀하세요.";
                recordBtn.disabled = false;
                transcriptDiv.innerHTML = "<p>챗봇이 준비되었습니다.</p>";
            };

            socket.onmessage = (event) => {
                if (event.data instanceof Blob) {
                    console.log("6. 서버로부터 음성(Blob) 데이터를 받았습니다.");
                    const audio = new Audio(URL.createObjectURL(event.data));
                    audio.play();
                    audio.onended = () => {
                        statusDiv.textContent = "녹음 버튼을 누르고 말씀하세요.";
                        recordBtn.disabled = false;
                        console.log("7. 음성 재생이 완료되었습니다.");
                    };
                } else {
                    const message = JSON.parse(event.data);
                    if (message.type === 'user_text') {
                        console.log("5. 서버로부터 인식된 텍스트를 받았습니다:", message.data);
                        addMessageToTranscript('user', message.data);
                    } else if (message.type === 'ai_text') {
                        console.log("5. 서버로부터 AI 답변 텍스트를 받았습니다:", message.data);
                        addMessageToTranscript('ai', message.data);
                    }
                }
            };

            socket.onclose = (event) => {
                console.error(`WebSocket 연결이 종료되었습니다. 코드: ${event.code}, 이유: ${event.reason}`);
                statusDiv.textContent = "서버 연결이 끊어졌습니다. 페이지를 새로고침하세요.";
                recordBtn.disabled = true;
            };

            socket.onerror = (error) => {
                console.error("WebSocket 오류 발생:", error);
                statusDiv.textContent = "연결 오류 발생! F12를 눌러 콘솔을 확인하세요.";
            };
        }
        
        async function startRecording() {
            console.log("3. 녹음 시작 버튼 클릭됨. 마이크 접근을 시도합니다.");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                
                mediaRecorder.ondataavailable = e => {
                    audioChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    console.log("4. 녹음 중지됨. 오디오 데이터를 서버로 전송합니다.");
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    if (socket?.readyState === WebSocket.OPEN) {
                        socket.send(audioBlob);
                    }
                    audioChunks = [];
                };

                mediaRecorder.start();
                isRecording = true;
                transcriptDiv.innerHTML = "";
                statusDiv.textContent = "말씀하세요...";
                recordBtn.textContent = "🎙️ 녹음 중지";
                recordBtn.classList.add('recording');
            } catch (err) {
                alert("마이크에 접근할 수 없습니다. 브라우저의 마이크 권한을 확인해주세요.");
                console.error("마이크 접근 오류:", err);
            }
        }

        function stopRecording() {
            if (mediaRecorder) mediaRecorder.stop();
            isRecording = false;
            statusDiv.textContent = "음성을 처리 중입니다...";
            recordBtn.textContent = "🎤 녹음 시작";
            recordBtn.classList.remove('recording');
            recordBtn.disabled = true;
        }
        
        function addMessageToTranscript(sender, text) {
            const p = document.createElement('p');
            p.classList.add('message');
            const prefix = sender === 'user' ? '👤 나:' : '🤖 Gemini:';
            const spanClass = sender === 'user' ? 'user' : 'ai';
            p.innerHTML = `<span class="${spanClass}">${prefix}</span> ${text}`;
            transcriptDiv.appendChild(p);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        }

        recordBtn.onclick = () => { isRecording ? stopRecording() : startRecording(); };

        // 페이지 로드 시 웹소켓 연결 시작
        connectWebSocket();
    </script>
</body>
</html>