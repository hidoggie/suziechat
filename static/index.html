<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŒì„± ì±—ë´‡ (Push-to-Talk)</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; height: 100vh; margin: 0; background-color: #f0f2f5; padding-top: 20px; box-sizing: border-box;}
        #container { width: 90%; max-width: 700px; text-align: center; }
        #status { font-size: 1.2em; color: #555; margin-bottom: 20px; background-color: #e9ecef; padding: 10px 20px; border-radius: 20px; text-align: center; transition: background-color 0.3s; }
        #recordBtn {
            font-size: 1.5em; padding: 20px 40px; border-radius: 50px; border: none; cursor: pointer; 
            background-color: #28a745; color: white; transition: background-color 0.3s; margin-bottom: 20px;
        }
        #recordBtn.recording { background-color: #dc3545; }
        #recordBtn:disabled { background-color: #6c757d; cursor: not-allowed; }
        #transcript { text-align: left; width: 100%; background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 50vh; overflow-y: auto; box-sizing: border-box;}
        .message { margin-bottom: 12px; line-height: 1.5; }
        .user { color: #005A9C; font-weight: bold; }
        .ai { color: #444; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #overlay-text { color: white; font-size: 2em; text-align: center; padding: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="container">
        <h1>ìŒì„± ì±—ë´‡ (ë²„íŠ¼ ì œì–´ ë°©ì‹)</h1>
        <div id="status">ì„œë²„ì— ì—°ê²° ì¤‘...</div>
        <button id="recordBtn" disabled>ğŸ¤ ë…¹ìŒ ì‹œì‘</button>
        <div id="transcript">
            <p>ì„œë²„ì— ì—°ê²°ë˜ë©´ ë…¹ìŒ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</p>
        </div>
    </div>
    <div id="overlay" class="hidden">
        <div id="overlay-text">ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.</div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const recordBtn = document.getElementById('recordBtn');
        const transcriptDiv = document.getElementById('transcript');
        const overlay = document.getElementById('overlay');
        let socket;

        // âœ¨âœ¨âœ¨ VAD ëŒ€ì‹  ì‚¬ìš©í•  MediaRecorder ê´€ë ¨ ë³€ìˆ˜ âœ¨âœ¨âœ¨
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        function connectWebSocket() {
         //   socket = new WebSocket("ws://127.0.0.1:8000/ws"); // ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œ
             const socketURL = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`;
             socket = new WebSocket(socketURL); // Render.com ë“± ì‹¤ì œ ì„œë²„ ë°°í¬ ì‹œ

            socket.onopen = () => {
                statusDiv.textContent = "ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.";
                recordBtn.disabled = false;
            };

            socket.onmessage = (event) => {
                if (event.data instanceof Blob) {
                    const audioUrl = URL.createObjectURL(event.data);
                    const audio = new Audio(audioUrl);
                    audio.play();
                    // ë‹µë³€ ì¬ìƒì´ ëë‚˜ë©´ ë‹¤ì‹œ ë…¹ìŒ ê°€ëŠ¥í•˜ë„ë¡ ë²„íŠ¼ í™œì„±í™”
                    audio.onended = () => {
                        recordBtn.disabled = false;
                        statusDiv.textContent = "ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.";
                    };
                } else {
                    const message = JSON.parse(event.data);
                    const p = document.createElement('p');
                    p.classList.add('message');
                    if (message.type === 'user_text') {
                        p.innerHTML = `<span class="user">ğŸ‘¤ ë‚˜:</span> ${message.data}`;
                    } else if (message.type === 'ai_text') {
                        p.innerHTML = `<span class="ai">ğŸ¤– Gemini:</span> ${message.data}`;
                    }
                    transcriptDiv.appendChild(p);
                    transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
                }
            };

            socket.onclose = () => {
                stopVoiceActivityDetection();

                // ì—°ê²°ì´ í•œ ë²ˆì´ë¼ë„ ì„±ê³µí–ˆë‹¤ê°€(true) ëŠì–´ì§„ ê²½ìš°ì—ë§Œ ì¢…ë£Œ ì˜¤ë²„ë ˆì´ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                if (connectionEstablished) {
                    overlay.classList.remove('hidden');
                } else {
                    // í˜ì´ì§€ ë¡œë”© ì‹œ ì²˜ìŒë¶€í„° ì—°ê²°ì— ì‹¤íŒ¨í•œ ê²½ìš°, ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
                    statusDiv.textContent = "ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°±ì—”ë“œ ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.";
                }


             //   statusDiv.textContent = "ì„¸ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                statusDiv.className = '';
                stopVoiceActivityDetection();

                // ì˜¤ë²„ë ˆì´ë¥¼ í‘œì‹œí•˜ì—¬ ì¢…ë£Œ ìƒíƒœë¥¼ ëª…í™•íˆ í•¨
                overlay.classList.remove('hidden');
            };
        }
        
        // âœ¨âœ¨âœ¨ ë…¹ìŒì„ ì‹œì‘í•˜ëŠ” í•¨ìˆ˜ âœ¨âœ¨âœ¨
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                // ë…¹ìŒ ë°ì´í„°ê°€ ë“¤ì–´ì˜¬ ë•Œë§ˆë‹¤ chunks ë°°ì—´ì— ì¶”ê°€
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                // ë…¹ìŒì´ ì¤‘ì§€ë˜ë©´ ì‹¤í–‰ë  ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                mediaRecorder.onstop = () => {
                    // ëª¨ì¸ ì˜¤ë””ì˜¤ ì²­í¬ë“¤ì„ í•˜ë‚˜ì˜ Blob ë°ì´í„°ë¡œ ë§Œë“¦
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(audioBlob); // ì›¹ì†Œì¼“ì„ í†µí•´ ì„œë²„ë¡œ ì „ì†¡
                    }
                    audioChunks = []; // ë‹¤ìŒ ë…¹ìŒì„ ìœ„í•´ ë°°ì—´ ë¹„ìš°ê¸°
                };

                mediaRecorder.start();
                isRecording = true;
                
                // UI ì—…ë°ì´íŠ¸
                statusDiv.textContent = "ë§ì”€í•˜ì„¸ìš”...";
                recordBtn.textContent = "ğŸ™ï¸ ë…¹ìŒ ì¤‘ì§€";
                recordBtn.classList.add('recording');
                transcriptDiv.innerHTML = ""; // ìƒˆ ëŒ€í™” ì‹œ ì´ì „ ë‚´ìš© ì§€ìš°ê¸°

            } catch (err) {
                alert("ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                console.error("ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:", err);
            }
        }

        // âœ¨âœ¨âœ¨ ë…¹ìŒì„ ì¤‘ì§€í•˜ëŠ” í•¨ìˆ˜ âœ¨âœ¨âœ¨
        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop(); // onstop ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ê°€ ìë™ìœ¼ë¡œ í˜¸ì¶œë¨
            }
            isRecording = false;

            // UI ì—…ë°ì´íŠ¸
            statusDiv.textContent = "ìŒì„±ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...";
            recordBtn.textContent = "ğŸ¤ ë…¹ìŒ ì‹œì‘";
            recordBtn.classList.remove('recording');
            recordBtn.disabled = true; // ì²˜ë¦¬ ì¤‘ì—ëŠ” ë²„íŠ¼ ë¹„í™œì„±í™”
        }

        // âœ¨âœ¨âœ¨ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ âœ¨âœ¨âœ¨
        recordBtn.onclick = () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        };

        connectWebSocket();
    </script>
</body>
</html>