<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini ìŒì„± ì±—ë´‡ (ìµœì¢…)</title>
    <style>body{font-family:sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;height:100vh;margin:0;background-color:#f0f2f5;padding-top:20px;box-sizing:border-box}#container{width:90%;max-width:700px;text-align:center}#status{font-size:1.2em;color:#333;margin-bottom:20px;background-color:#e9ecef;padding:10px 20px;border-radius:20px;text-align:center;font-weight:700}#recordBtn{font-size:1.5em;padding:20px 40px;border-radius:50px;border:none;cursor:pointer;background-color:#28a745;color:#fff;transition:background-color .3s;margin-bottom:20px}#recordBtn.recording{background-color:#dc3545}#recordBtn:disabled{background-color:#6c757d;cursor:not-allowed}#transcript{text-align:left;width:100%;background-color:#fff;border-radius:8px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,.1);height:50vh;overflow-y:auto;box-sizing:border-box}.message{margin-bottom:12px;line-height:1.5}.user{color:#005a9c;font-weight:700}.ai{color:#444}#overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:1000}#overlay-text{color:#fff;font-size:2em;text-align:center;padding:20px}.hidden{display:none}</style>
</head>
<body>
    <div id="container">
        <h1>ìŒì„± ì±—ë´‡</h1>
        <div id="status">ì„œë²„ì— ì—°ê²° ì¤‘...</div>
        <button id="recordBtn" disabled>ğŸ¤ ë…¹ìŒ ì‹œì‘</button>
        <div id="transcript"></div>
    </div>
    <div id="overlay" class="hidden">
        <div id="overlay-text">ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.</div>
    </div>
    <script>
        const statusDiv = document.getElementById('status'), recordBtn = document.getElementById('recordBtn'), transcriptDiv = document.getElementById('transcript'), overlay = document.getElementById('overlay');
        let socket, mediaRecorder, audioChunks = [], isRecording = false, connectionEstablished = false;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const socketURL = `${protocol}//${host}/ws`;
            socket = new WebSocket(socketURL);

            socket.onopen = () => {
                connectionEstablished = true;
                statusDiv.textContent = "ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.";
                recordBtn.disabled = false;
                transcriptDiv.innerHTML = "<p>ì±—ë´‡ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.</p>";
            };

            socket.onmessage = (event) => {
                if (event.data instanceof Blob) {
                    const audio = new Audio(URL.createObjectURL(event.data));
                    audio.play();
                    audio.onended = () => { recordBtn.disabled = false; statusDiv.textContent = "ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”."; };
                } else {
                    const message = JSON.parse(event.data);
                    const p = document.createElement('p');
                    p.classList.add('message');
                    if (message.type === 'user_text') p.innerHTML = `<span class="user">ğŸ‘¤ ë‚˜:</span> ${message.data}`;
                    else if (message.type === 'ai_text') p.innerHTML = `<span class="ai">ğŸ¤– Gemini:</span> ${message.data}`;
                    transcriptDiv.appendChild(p);
                    transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
                }
            };
            socket.onclose = () => {
                recordBtn.disabled = true;
                if (connectionEstablished) overlay.classList.remove('hidden');
                else statusDiv.textContent = "ì„œë²„ ì—°ê²° ì‹¤íŒ¨! ë°±ì—”ë“œ ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
            };
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    if (socket?.readyState === WebSocket.OPEN) socket.send(audioBlob);
                    audioChunks = [];
                };
                mediaRecorder.start();
                isRecording = true;
                transcriptDiv.innerHTML = "";
                statusDiv.textContent = "ë§ì”€í•˜ì„¸ìš”...";
                recordBtn.textContent = "ğŸ™ï¸ ë…¹ìŒ ì¤‘ì§€";
                recordBtn.classList.add('recording');
            } catch (err) { alert("ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");}
        }

        function stopRecording() {
            if (mediaRecorder) mediaRecorder.stop();
            isRecording = false;
            statusDiv.textContent = "ìŒì„±ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...";
            recordBtn.textContent = "ğŸ¤ ë…¹ìŒ ì‹œì‘";
            recordBtn.classList.remove('recording');
            recordBtn.disabled = true;
        }

        recordBtn.onclick = () => { isRecording ? stopRecording() : startRecording(); };
        connectWebSocket();
    </script>
</body>
</html>