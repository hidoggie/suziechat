<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Docent Bot</title>
    <style>
      body{
        font-family:sans-serif;
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:flex-start;
        height:100vh;
        margin:0;
        background-color:#f0f2f5;
        padding-top:20px;
        box-sizing:border-box
        }

        #container{
            width:90%;
            max-width:700px;
            text-align:center
            }
        #status{
            font-size:1.2em;
            color:#333;
            margin-bottom:20px;
            background-color:#e9ecef;
            padding:10px 20px;
            border-radius:20px;
            text-align:center;
            font-weight:700
            }

        #recordBtn,#playBtn{
            font-size:1.5em;
            padding:20px 40px;
            border-radius:50px;
            border:none;
            cursor:pointer;
            color:#fff;
            transition:background-color .3s;
            margin-bottom:20px
        }
        #recordBtn{background-color:#28a745}

        #recordBtn.recording{
            background-color:#dc3545
            }
        #recordBtn:disabled{
            background-color:#6c757d;
            cursor:not-allowed
            }
        /* âœ¨ ì¬ìƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        #playBtn { background-color: #007bff; }

        #transcript{
            text-align:left;
            width:100%;
            background-color:#fff;
            border-radius:8px;
            padding:20px;
            box-shadow:0 2px 4px rgba(0,0,0,.1);
            height:50vh;
            overflow-y:auto;
            box-sizing:border-box
            }
        .message{
            margin-bottom:12px;
            line-height:1.5
        }
        .user{
            color:#005a9c;
            font-weight:700
        }
        .ai{
            color:#444
        }
        
        .hidden{
            display:none
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>AI Docent Bot</h1>
        <div id="status">ì„œë²„ì— ì—°ê²° ì¤‘...</div>
        <button id="recordBtn" disabled>ğŸ¤ ì§ˆë¬¸ Start</button>
        <button id="playBtn" class="hidden">â–¶ï¸ ë‹µë³€ ë“£ê¸°</button> 
        <div id="transcript"></div>
    </div>
    
    <script>
        const statusDiv = document.getElementById('status');
        const recordBtn = document.getElementById('recordBtn');
        const playBtn = document.getElementById('playBtn'); // âœ¨ ì¬ìƒ ë²„íŠ¼ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const transcriptDiv = document.getElementById('transcript');

        let socket;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

 // âœ¨ ì¬ìƒí•  ì˜¤ë””ì˜¤ ê°ì²´ë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let audioContext; // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ê°ì²´
        let lastReceivedAudioBuffer = null; // ë””ì½”ë”©ëœ ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ì €ì¥í•  ë³€ìˆ˜

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ë¡œ ì›¹ì†Œì¼“ ì—°ê²° ì‹œì‘
        connectWebSocket();   

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const socketURL = `${protocol}//${host}/ws`;
            socket = new WebSocket(socketURL);

            socket.onopen = () => {
                statusDiv.textContent = "Start ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.";
                recordBtn.disabled = false;
                transcriptDiv.innerHTML = "<p>ë„ìŠ¨íŠ¸ë´‡ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.</p>";
            };

            socket.onmessage = async (event) => {
                if (event.data instanceof Blob) {
                    console.log("ì„œë²„ë¡œë¶€í„° ìŒì„±(Blob) ë°ì´í„°ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.");

                // âœ¨ ë°›ì€ Blobì„ ArrayBufferë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                    lastReceivedAudioBuffer = await event.data.arrayBuffer();
 
                    // UI ì—…ë°ì´íŠ¸
                    statusDiv.textContent = "ë‹µë³€ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤. ë“£ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
                    recordBtn.disabled = true;
                    playBtn.classList.remove('hidden');

                } else {
                    const message = JSON.parse(event.data);
                    addMessageToTranscript(message.type, message.data);
                }
            };

            socket.onclose = () => {
                alert("ì„œë²„ì™€ì˜ ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
                statusDiv.textContent = "ì—°ê²° ì¢…ë£Œë¨";
                recordBtn.disabled = true;
                playBtn.classList.add('hidden');
            };
        }

        // âœ¨âœ¨âœ¨ Web Audio APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì˜¤ë””ì˜¤ë¥¼ ì¬ìƒí•˜ëŠ” ìƒˆë¡œìš´ í•¨ìˆ˜ âœ¨âœ¨âœ¨
        function playAudioBuffer(buffer) {
            if (!audioContext) {
                console.log("ìƒˆ AudioContextë¥¼ ìƒì„±í•©ë‹ˆë‹¤.");
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // iOSì—ì„œ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ê°€ ì •ì§€ ìƒíƒœì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¬ìƒ ì „ì— í•­ìƒ í™œì„±í™” ì‹œë„
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            // ArrayBufferë¥¼ ë””ì½”ë”©í•˜ì—¬ ì˜¤ë””ì˜¤ ì†ŒìŠ¤ë¡œ ë§Œë“¦
            audioContext.decodeAudioData(buffer, (decodedBuffer) => {
                const source = audioContext.createBufferSource();
                source.buffer = decodedBuffer;
                source.connect(audioContext.destination);
                source.start(0); // ì¦‰ì‹œ ì¬ìƒ

                // ì¬ìƒì´ ëë‚˜ë©´ ë…¹ìŒ ë²„íŠ¼ í™œì„±í™”
                source.onended = () => {
                    console.log("ìŒì„± ì¬ìƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    statusDiv.textContent = "ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.";
                    recordBtn.disabled = false;
                };
            }, (error) => {
                console.error("ì˜¤ë””ì˜¤ ë””ì½”ë”© ì˜¤ë¥˜:", error);
                alert("ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì¬ìƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                recordBtn.disabled = false; // ì˜¤ë¥˜ ì‹œì—ë„ ë²„íŠ¼ í™œì„±í™”
            });
        }
        
        // âœ¨ ì¬ìƒ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ìˆ˜ì •
        playBtn.onclick = () => {
            if (lastReceivedAudioBuffer) {
                console.log("ì¬ìƒ ë²„íŠ¼ í´ë¦­ë¨. Web Audio APIë¡œ ì¬ìƒí•©ë‹ˆë‹¤.");
                playAudioBuffer(lastReceivedAudioBuffer.slice(0)); // ë²„í¼ ë³µì‚¬ë³¸ ì „ë‹¬
                lastReceivedAudioBuffer = null; // í•œ ë²ˆë§Œ ì¬ìƒí•˜ë„ë¡ ë²„í¼ ë¹„ìš°ê¸°
                statusDiv.textContent = "ë‹µë³€ì„ ì¬ìƒí•©ë‹ˆë‹¤...";
                playBtn.classList.add('hidden');
            }
        };

        
        async function startRecording() {
            if (!audioContext) {
                 audioContext = new (window.AudioContext || window.webkitAudioContext)();
                 if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                 }
            }
            // ì´í•˜ ë¡œì§ì€ ì´ì „ê³¼ ë™ì¼
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    if (socket?.readyState === WebSocket.OPEN) socket.send(audioBlob);
                    audioChunks = [];
                };
                mediaRecorder.start();
                isRecording = true;
                transcriptDiv.innerHTML = "";
                statusDiv.textContent = "ë§ì”€í•˜ì„¸ìš”...";
                recordBtn.textContent = "ğŸ™ï¸ ë…¹ìŒ ì¤‘ì§€";
                recordBtn.classList.add('recording');
                playBtn.classList.add('hidden');
            } catch (err) { alert("ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
        }

        function stopRecording() {
            if (mediaRecorder) mediaRecorder.stop();
            isRecording = false;
            statusDiv.textContent = "ìŒì„±ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...";
            recordBtn.textContent = "ğŸ¤ ì§ˆë¬¸ Start";
            recordBtn.classList.remove('recording');
            recordBtn.disabled = true;
        }

        function addMessageToTranscript(sender, text) {
            const p = document.createElement('p');
            p.classList.add('message');
            p.innerHTML = `<span class="${sender === 'user' ? 'user' : 'ai'}">${sender === 'user' ? 'ğŸ‘¤ ë‚˜:' : 'ğŸ¤– DocentBot:'}</span> ${text}`;
            transcriptDiv.appendChild(p);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        }

        recordBtn.onclick = () => { isRecording ? stopRecording() : startRecording(); };
//        connectWebSocket();
    </script>
</body>
</html>