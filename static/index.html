<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 음성 챗봇 (Push-to-Talk)</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; height: 100vh; margin: 0; background-color: #f0f2f5; padding-top: 20px; box-sizing: border-box;}
        #container { width: 90%; max-width: 700px; text-align: center; }
        #status { font-size: 1.2em; color: #555; margin-bottom: 20px; background-color: #e9ecef; padding: 10px 20px; border-radius: 20px; text-align: center; transition: background-color 0.3s; }
        #recordBtn { font-size: 1.5em; padding: 20px 40px; border-radius: 50px; border: none; cursor: pointer; background-color: #28a745; color: white; transition: background-color 0.3s; margin-bottom: 20px; }
        #recordBtn.recording { background-color: #dc3545; }
        #recordBtn:disabled { background-color: #6c757d; cursor: not-allowed; }
        #transcript { text-align: left; width: 100%; background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 50vh; overflow-y: auto; box-sizing: border-box;}
        .message { margin-bottom: 12px; line-height: 1.5; }
        .user { color: #005A9C; font-weight: bold; }
        .ai { color: #444; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        #overlay-text { color: white; font-size: 2em; text-align: center; padding: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="container">
        <h1>음성 챗봇 (버튼 제어 방식)</h1>
        <div id="status">서버에 연결 중...</div>
        <button id="recordBtn" disabled>🎤 녹음 시작</button>
        <div id="transcript"><p>서버에 연결되면 녹음 버튼이 활성화됩니다.</p></div>
    </div>
    <div id="overlay" class="hidden">
        <div id="overlay-text">대화가 종료되었습니다.<br><br>페이지를 새로고침하여 다시 시작하세요.</div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');
        const recordBtn = document.getElementById('recordBtn');
        const transcriptDiv = document.getElementById('transcript');
        const overlay = document.getElementById('overlay');
        let socket, mediaRecorder, audioChunks = [], isRecording = false;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const socketURL = `${protocol}//${host}/ws`;
            socket = new WebSocket(socketURL);

            socket.onopen = () => { statusDiv.textContent = "녹음 버튼을 누르고 말씀하세요."; recordBtn.disabled = false; };
            socket.onmessage = (event) => {
                if (event.data instanceof Blob) {
                    const audio = new Audio(URL.createObjectURL(event.data));
                    audio.play();
                    audio.onended = () => { recordBtn.disabled = false; statusDiv.textContent = "녹음 버튼을 누르고 말씀하세요."; };
                } else {
                    const message = JSON.parse(event.data);
                    const p = document.createElement('p');
                    p.classList.add('message');
                    if (message.type === 'user_text') p.innerHTML = `<span class="user">👤 나:</span> ${message.data}`;
                    else if (message.type === 'ai_text') p.innerHTML = `<span class="ai">🤖 Gemini:</span> ${message.data}`;
                    transcriptDiv.appendChild(p);
                    transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
                }
            };
            socket.onclose = () => { overlay.classList.remove('hidden'); };
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm;codecs=opus' });
                    if (socket?.readyState === WebSocket.OPEN) socket.send(audioBlob);
                    audioChunks = [];
                };
                mediaRecorder.start();
                isRecording = true;
                statusDiv.textContent = "말씀하세요...";
                recordBtn.textContent = "🎙️ 녹음 중지";
                recordBtn.classList.add('recording');

            } catch (err) { alert("마이크에 접근할 수 없습니다."); console.error("Mic error:", err); }
        }

        function stopRecording() {
            if (mediaRecorder) mediaRecorder.stop();
            isRecording = false;
            statusDiv.textContent = "음성을 처리 중입니다...";
            recordBtn.textContent = "🎤 녹음 시작";
            recordBtn.classList.remove('recording');
            recordBtn.disabled = true;
        }

        recordBtn.onclick = () => { isRecording ? stopRecording() : startRecording(); };
        connectWebSocket();
    </script>
</body>
</html>