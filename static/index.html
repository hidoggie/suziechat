<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini ìŒì„± ì±—ë´‡ (ìµœì¢… ì•ˆì •í™”)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; height: 100vh; margin: 0; background-color: #f0f2f5; padding-top: 20px; box-sizing: border-box; }
        #container { width: 90%; max-width: 700px; text-align: center; }
        #status { font-size: 1.2em; color: #333; margin-bottom: 20px; background-color: #e9ecef; padding: 10px 20px; border-radius: 20px; text-align: center; font-weight: bold; }
        #recordBtn { font-size: 1.5em; padding: 20px 40px; border-radius: 50px; border: none; cursor: pointer; background-color: #28a745; color: white; transition: background-color 0.3s; margin-bottom: 20px; }
        #recordBtn.recording { background-color: #dc3545; }
        #recordBtn:disabled { background-color: #6c757d; cursor: not-allowed; }
        #transcript { text-align: left; width: 100%; background-color: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 50vh; overflow-y: auto; box-sizing: border-box;}
        .message { margin-bottom: 12px; line-height: 1.5; }
        .user { color: #005A9C; font-weight: bold; }
        .ai { color: #444; }
    </style>
</head>
<body>
    <div id="container">
        <h1>ìŒì„± ì±—ë´‡ (ìµœì¢… ì•ˆì •í™” ë²„ì „)</h1>
        <div id="status">ì„œë²„ì— ì—°ê²° ì¤‘...</div>
        <button id="recordBtn" disabled>ğŸ¤ ë…¹ìŒ ì‹œì‘</button>
        <div id="transcript"><p>ì„œë²„ ì—°ê²°ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤...</p></div>
    </div>
    <script>
        const statusDiv = document.getElementById('status');
        const recordBtn = document.getElementById('recordBtn');
        const transcriptDiv = document.getElementById('transcript');
        
        let socket;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        function connectWebSocket() {
            console.log("1. WebSocket ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...");
            
            // Render.com ë°°í¬ í™˜ê²½ì„ ìœ„í•œ ë™ì  URL ìƒì„±
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const socketURL = `${protocol}//${host}/ws`;

            socket = new WebSocket(socketURL);

            socket.onopen = () => {
                console.log("2. WebSocket ì—°ê²°ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.");
                statusDiv.textContent = "ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.";
                recordBtn.disabled = false;
                transcriptDiv.innerHTML = "<p>ì±—ë´‡ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.</p>";
            };

            socket.onmessage = (event) => {
                if (event.data instanceof Blob) {
                    console.log("6. ì„œë²„ë¡œë¶€í„° ìŒì„±(Blob) ë°ì´í„°ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.");
                    const audio = new Audio(URL.createObjectURL(event.data));
                    audio.play();
                    audio.onended = () => {
                        statusDiv.textContent = "ë…¹ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”.";
                        recordBtn.disabled = false;
                        console.log("7. ìŒì„± ì¬ìƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    };
                } else {
                    const message = JSON.parse(event.data);
                    if (message.type === 'user_text') {
                        console.log("5. ì„œë²„ë¡œë¶€í„° ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤:", message.data);
                        addMessageToTranscript('user', message.data);
                    } else if (message.type === 'ai_text') {
                        console.log("5. ì„œë²„ë¡œë¶€í„° AI ë‹µë³€ í…ìŠ¤íŠ¸ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤:", message.data);
                        addMessageToTranscript('ai', message.data);
                    }
                }
            };

            socket.onclose = (event) => {
                console.error(`WebSocket ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì½”ë“œ: ${event.code}, ì´ìœ : ${event.reason}`);
                statusDiv.textContent = "ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.";
                recordBtn.disabled = true;
            };

            socket.onerror = (error) => {
                console.error("WebSocket ì˜¤ë¥˜ ë°œìƒ:", error);
                statusDiv.textContent = "ì—°ê²° ì˜¤ë¥˜ ë°œìƒ! F12ë¥¼ ëˆŒëŸ¬ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.";
            };
        }
        
        async function startRecording() {
            console.log("3. ë…¹ìŒ ì‹œì‘ ë²„íŠ¼ í´ë¦­ë¨. ë§ˆì´í¬ ì ‘ê·¼ì„ ì‹œë„í•©ë‹ˆë‹¤.");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                
                mediaRecorder.ondataavailable = e => {
                    audioChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    console.log("4. ë…¹ìŒ ì¤‘ì§€ë¨. ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ì„œë²„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.");
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    if (socket?.readyState === WebSocket.OPEN) {
                        socket.send(audioBlob);
                    }
                    audioChunks = [];
                };

                mediaRecorder.start();
                isRecording = true;
                transcriptDiv.innerHTML = "";
                statusDiv.textContent = "ë§ì”€í•˜ì„¸ìš”...";
                recordBtn.textContent = "ğŸ™ï¸ ë…¹ìŒ ì¤‘ì§€";
                recordBtn.classList.add('recording');
            } catch (err) {
                alert("ë§ˆì´í¬ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì˜ ë§ˆì´í¬ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                console.error("ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:", err);
            }
        }

        function stopRecording() {
            if (mediaRecorder) mediaRecorder.stop();
            isRecording = false;
            statusDiv.textContent = "ìŒì„±ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...";
            recordBtn.textContent = "ğŸ¤ ë…¹ìŒ ì‹œì‘";
            recordBtn.classList.remove('recording');
            recordBtn.disabled = true;
        }
        
        function addMessageToTranscript(sender, text) {
            const p = document.createElement('p');
            p.classList.add('message');
            const prefix = sender === 'user' ? 'ğŸ‘¤ ë‚˜:' : 'ğŸ¤– Gemini:';
            const spanClass = sender === 'user' ? 'user' : 'ai';
            p.innerHTML = `<span class="${spanClass}">${prefix}</span> ${text}`;
            transcriptDiv.appendChild(p);
            transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
        }

        recordBtn.onclick = () => { isRecording ? stopRecording() : startRecording(); };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì›¹ì†Œì¼“ ì—°ê²° ì‹œì‘
        connectWebSocket();
    </script>
</body>
</html>