<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Docent Bot</title>
    <style>
       body, input, button { 
        font-family: sans-serif; 
        font-size: 16px; 
        }

        #container { 
            width: 90%; 
            max-width: 700px; 
            margin: 0 auto; 
        }
        #transcript { 
            border: 1px solid #ccc; 
            padding: 10px; 
            height: 50vh; 
            overflow-y: scroll; 
            margin-bottom: 10px; 
            background-color: #fff; 
        }
        #input-area { 
            display: flex; 
            gap: 10px; 
        }
        #text-input { 
            flex-grow: 1; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 5px; 
        }
        #recordBtn, #send-btn, #playBtn { 
            padding: 10px 15px; 
            border-radius: 5px; 
            border: none; 
            color: white; 
            cursor: pointer; 
        }
        #recordBtn { 
            background-color: #28a745; 
        }
        #recordBtn.recording { 
            background-color: #dc3545; 
        }
        #send-btn { 
            background-color: #007bff; 
        }
        #playBtn { 
            background-color: #17a2b8; 
        }
        .hidden { 
            display: none; 
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>ÎìÄÏñºÎ™®Îìú ÏùåÏÑ± Ï±óÎ¥á</h1>
        <div id="transcript"></div>
        <div id="input-area">
            <button id="recordBtn" disabled>üé§</button>
            <input type="text" id="text-input" placeholder="ÎòêÎäî ÌÖçÏä§Ìä∏Î°ú ÏßàÎ¨∏ÌïòÏÑ∏Ïöî...">
            <button id="send-btn">Ï†ÑÏÜ°</button>
        </div>
        <button id="playBtn" class="hidden" style="margin-top: 10px;">‚ñ∂Ô∏è ÎãµÎ≥Ä Îì£Í∏∞</button>
    </div>
    
    <script>
        // --- ÏöîÏÜå Í∞ÄÏ†∏Ïò§Í∏∞ ---
        const recordBtn = document.getElementById('recordBtn');
        const playBtn = document.getElementById('playBtn');
        const transcriptDiv = document.getElementById('transcript');
        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');
        
        let socket, mediaRecorder, audioChunks = [], isRecording = false;
        let lastInputWasVoice = false; // ‚ú® ÎßàÏßÄÎßâ ÏûÖÎ†• Î∞©ÏãùÏùÑ Í∏∞ÏñµÌïòÎäî ÌîåÎûòÍ∑∏
        let audioContext, lastReceivedAudioBlob = null;
        
        // --- Ìó¨Ìçº Ìï®ÏàòÎì§ ---
        function isIOS() { return /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream; }
        function addMessageToTranscript(sender, text) { /* Ïù¥Ï†ÑÍ≥º ÎèôÏùº */ }

        // --- ÏõπÏÜåÏºì Î°úÏßÅ ---
        function connectWebSocket() {
            const socketURL = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`;
            socket = new WebSocket(socketURL);
            socket.onopen = () => { recordBtn.disabled = false; sendBtn.disabled = false; addMessageToTranscript('system', 'Ï±óÎ¥áÏù¥ Ï§ÄÎπÑÎêòÏóàÏäµÎãàÎã§.'); };
            socket.onmessage = async (event) => {
                if (event.data instanceof Blob) {
                    lastReceivedAudioBlob = event.data;
                    const shouldAutoplay = lastInputWasVoice && !isIOS(); // ÏùåÏÑ± ÏûÖÎ†• & Non-iOSÏùº ÎïåÎßå ÏûêÎèôÏû¨ÏÉù
                    if (shouldAutoplay) {
                        const audio = new Audio(URL.createObjectURL(lastReceivedAudioBlob));
                        audio.play();
                        audio.onended = () => enableInputs();
                    } else {
                        playBtn.classList.remove('hidden'); // Í∑∏ Ïô∏ Î™®Îì† Í≤ΩÏö∞ Î≤ÑÌäº ÌëúÏãú
                    }
                } else {
                    const message = JSON.parse(event.data);
                    addMessageToTranscript(message.type, message.data);
                }
            };
            socket.onclose = () => { /* Ïù¥Ï†ÑÍ≥º ÎèôÏùº */ };
        }

        // --- ÏûÖÎ†• UI Ï†úÏñ¥ ---
        function disableInputs() { recordBtn.disabled = true; sendBtn.disabled = true; textInput.disabled = true; }
        function enableInputs() { recordBtn.disabled = false; sendBtn.disabled = false; textInput.disabled = false; }
        
        // --- Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ ---
        recordBtn.onclick = () => { isRecording ? stopRecording() : startRecording(); };
        sendBtn.onclick = sendTextMessage;
        textInput.addEventListener('keyup', e => { if (e.key === 'Enter') sendTextMessage(); });
        playBtn.onclick = playReceivedAudio;

        function sendTextMessage() {
            const text = textInput.value;
            if (!text || socket.readyState !== WebSocket.OPEN) return;
            lastInputWasVoice = false; // ‚ú® ÏûÖÎ†• Î∞©Ïãù ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
            socket.send(JSON.stringify({ type: 'text', data: text }));
            addMessageToTranscript('user', text);
            textInput.value = "";
            disableInputs();
        }

        async function startRecording() {
            lastInputWasVoice = true; // ‚ú® ÏûÖÎ†• Î∞©Ïãù ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
            disableInputs();
            // ... (Ïù¥Ï†Ñ startRecording Î°úÏßÅÍ≥º Í±∞Ïùò ÎèôÏùº, MediaRecorder ÏÇ¨Ïö©)
            isRecording = true; recordBtn.classList.add('recording');
        }

        function stopRecording() {
            if (mediaRecorder) mediaRecorder.stop();
            isRecording = false;
            recordBtn.classList.remove('recording');
        }

        function playReceivedAudio() {
            if (!lastReceivedAudioBlob) return;
            const audio = new Audio(URL.createObjectURL(lastReceivedAudioBlob));
            audio.play();
            audio.onended = () => enableInputs();
            playBtn.classList.add('hidden');
            lastReceivedAudioBlob = null;
        }

</script>
</body>
</html>