<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë¹„ì „ ë„ìŠ¨íŠ¸</title>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        #ar-container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .ar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; pointer-events: none; }
        .ar-button { padding: 10px 20px; font-size: 1.2em; border-radius: 5px; border: none; background-color: rgba(0,0,0,0.6); color: white; cursor: pointer; pointer-events: all; }
        #ar-description-box { background-color: rgba(0,0,0,0.8); color: white; padding: 15px; border-radius: 10px; max-height: 40%; overflow-y: auto; pointer-events: all; margin: 0 auto 20px auto; max-width: 90%; }
        #capture-button-container { width: 100%; text-align: center; pointer-events: all; }
        #captureBtn { width: 70px; height: 70px; border-radius: 50%; border: 4px solid white; background-color: rgba(255,255,255,0.3); }
        .hidden { display: none; }
        #progress-bar { width: 0%; height: 5px; background-color: #007bff; transition: width 0.5s; }
    </style>
</head>
<body>
    <div id="ar-container">
        <video id="video" playsinline autoplay></video>
        <canvas id="canvas" class="hidden"></canvas>
        <div class="ar-overlay">
            <div style="display: flex; justify-content: space-between;">
                <button id="back-to-chat-btn" class="ar-button">â†©ï¸ ì±—ë´‡ìœ¼ë¡œ</button>
            </div>
            <div id="ar-description-box" class="hidden">
                <p id="ar-text"></p>
                <div id="progress-bar-container" style="background-color: #555; border-radius: 5px;"><div id="progress-bar"></div></div>
                <button id="ar-tts-btn" class="ar-button hidden" style="margin-top: 10px; width: 100%;">ğŸ”Š ìŒì„± ì•ˆë‚´</button>
            </div>
            <div id="capture-button-container">
                <button id="captureBtn" title="ì´ë¯¸ì§€ ì°¾ê¸°"></button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const backToChatBtn = document.getElementById('back-to-chat-btn');
        const descriptionBox = document.getElementById('ar-description-box');
        const arText = document.getElementById('ar-text');
        const arTtsBtn = document.getElementById('ar-tts-btn');
        const progressBar = document.getElementById('progress-bar');
        
        let currentAudio = null;

        // 1. ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
            } catch (err) {
                alert("ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                window.history.back(); // ì´ì „ í˜ì´ì§€(ì±—ë´‡)ë¡œ ëŒì•„ê°€ê¸°
            }
        }

        // 2. ì‚¬ì§„ ì´¬ì˜ ë° ì„œë²„ ì „ì†¡
        captureBtn.onclick = async () => {
            // UI ì´ˆê¸°í™” ë° ë¡œë”© ìƒíƒœ í‘œì‹œ
            descriptionBox.classList.remove('hidden');
            arTtsBtn.classList.add('hidden');
            arText.textContent = "ì´ë¯¸ì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...";
            progressBar.style.width = '0%';
            captureBtn.disabled = true;

            // ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ë¥¼ Base64 ë°ì´í„°ë¡œ ë³€í™˜
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // ì„œë²„ë¡œ ì´ë¯¸ì§€ ë°ì´í„° ì „ì†¡
            try {
                progressBar.style.width = '30%';
                const response = await fetch('/api/recognize-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });
                
                progressBar.style.width = '70%';
                if (!response.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                const data = await response.json();
                
                // ê²°ê³¼ í‘œì‹œ
                arText.textContent = data.description;
                if (data.status === 'success') {
                    arTtsBtn.classList.remove('hidden');
                }
            } catch (err) {
                arText.textContent = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}`;
            } finally {
                progressBar.style.width = '100%';
                setTimeout(() => { progressBar.style.width = '0%'; }, 1000);
                captureBtn.disabled = false;
            }
        };

        // 3. ìŒì„± ì•ˆë‚´ ë“£ê¸° (ì¬ìƒ/ì¤‘ì§€ í† ê¸€)
 arTtsBtn.onclick = async () => {
    const text = arText.textContent;
    if (!text) return;

    arTtsBtn.disabled = true;
    arTtsBtn.textContent = "ğŸ”Š ìƒì„± ì¤‘...";
    let currentAudio = null;

    // ì¬ìƒ/ì¤‘ì§€ í† ê¸€ ë¡œì§
    if (currentAudio && !currentAudio.paused) {
        currentAudio.pause();
        arTtsBtn.textContent = "â–¶ï¸ ì´ì–´ ë“£ê¸°";
        arTtsBtn.disabled = false;
        return;
    }
    if (currentAudio && currentAudio.paused) {
        currentAudio.play();
        arTtsBtn.textContent = "â¸ï¸ ë“£ê¸° ì¤‘ì§€";
        arTtsBtn.disabled = false;
        return;
    }

    try {
        const response = await fetch('/api/tts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ "text_to_speak": text })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detail || `ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜`);
        }
        const data = await response.json();
        if (data.audio) {
            currentAudio = new Audio("data:audio/mp3;base64," + data.audio);
            currentAudio.play();
            arTtsBtn.textContent = "â¸ï¸ ë“£ê¸° ì¤‘ì§€";
            arTtsBtn.disabled = false;
            currentAudio.onended = () => {
                arTtsBtn.textContent = "ğŸ”Š ìŒì„± ì•ˆë‚´";
                currentAudio = null;
            };
        } else {
            throw new Error("ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    } catch (e) {
        alert(`ìŒì„± ìƒì„± ì‹¤íŒ¨: ${e.message}`);
        arTtsBtn.disabled = false;
        arTtsBtn.textContent = "ğŸ”Š ìŒì„± ì•ˆë‚´";
    }
};

        // 4. ì±—ë´‡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        backToChatBtn.onclick = () => {
            // ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ì •ì§€
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            // í˜„ì¬ ì°½ì„ ë‹«ê±°ë‚˜, ì´ì „ í˜ì´ì§€ë¡œ ì´ë™
            // ìƒˆ íƒ­ìœ¼ë¡œ ì—´ë ¸ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ window.close() ì‹œë„
            window.close();
            // ì‹¤íŒ¨ ì‹œ, ì´ì „ í˜ì´ì§€ë¡œ
            if(!window.closed) {
                window.history.back();
            }
        };
        
        startCamera();
    });
    </script>
</body>
</html>