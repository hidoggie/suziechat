<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        .ar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; box-sizing: border-box; pointer-events: none;}
        .ar-button { padding: 10px 20px; font-size: 1.2em; border-radius: 5px; border: none; background-color: rgba(0,0,0,0.6); color: white; cursor: pointer; pointer-events: all; }
        #ar-description-box { background-color: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 10px; max-height: 40%; overflow-y: auto; pointer-events: all; margin: 0 auto 20px auto; max-width: 90%; }
        .hidden { display: none; }
        /* âœ¨ ëŒì•„ê°€ê¸° ë²„íŠ¼ì„ ìœ„í•œ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        #back-button-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 20;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <a-scene mindar-image="imageTargetSrc: /static/targets.mind; autoStart: true; uiScanning: #scanningUI" 
             color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        </a-scene>

    <div class="ar-overlay">
        <div id="back-button-container">
            <button id="back-to-chat-btn" class="ar-button">â†©ï¸ ì±—ë´‡ìœ¼ë¡œ ëŒì•„ê°€ê¸° (ì°½ ë‹«ê¸°)</button>
        </div>

        <div id="scanningUI" class="hidden">
            </div>
        <div id="ar-description-box" class="hidden">
            <p id="ar-text"></p>
            <button id="ar-tts-btn" class="ar-button" style="margin-top: 10px; width: 100%;">ğŸ”Š ìŒì„± ì•ˆë‚´</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const sceneEl = document.querySelector('a-scene');
        const descriptionBox = document.getElementById('ar-description-box');
        const arText = document.getElementById('ar-text');
        const arTtsBtn = document.getElementById('ar-tts-btn');
        let pdfContent = [];
        let audioContext;

        async function initialize() {
            try {
                const response = await fetch('/api/pdf-content');
                pdfContent = await response.json();

                // âœ¨âœ¨âœ¨ AR ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ a-sceneì— ì§ì ‘ ì—°ê²° (í•µì‹¬ ìˆ˜ì •) âœ¨âœ¨âœ¨
                sceneEl.addEventListener("targetFound", event => {
                    const targetIndex = event.detail.target.index;
                    console.log(`Target Found, index: ${targetIndex}`);
                    
                    const allImages = pdfContent.flatMap(p => p.images);
                    const foundImageName = allImages[targetIndex];
                    
                    if (foundImageName) {
                        const page = pdfContent.find(p => p.images.includes(foundImageName));
                        if (page) {
                            arText.textContent = page.text;
                            descriptionBox.classList.remove('hidden');
                        }
                    }
                });

                sceneEl.addEventListener("targetLost", event => {
                    descriptionBox.classList.add('hidden');
                });

            } catch (e) {
                console.error("AR ì»¨í…ì¸  ë¡œë”© ì˜¤ë¥˜:", e);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¶€ëª¨ ì°½ì— ì•Œë¦´ ìˆ˜ ìˆìŒ (ì„ íƒ ì‚¬í•­)
            }
        }
        
        // âœ¨ 2. ëŒì•„ê°€ê¸° ë²„íŠ¼ì— ì°½ ë‹«ê¸° ê¸°ëŠ¥ ì¶”ê°€
        const backToChatBtn = document.getElementById('back-to-chat-btn');
        backToChatBtn.onclick = () => {
            // ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ìŠ¤ìŠ¤ë¡œ ì°½ì„ ë‹«ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            window.close();
        };

        
        arTtsBtn.onclick = async () => {
            const text = arText.textContent;
            if (!text) return;
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();

            const response = await fetch('/api/tts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text_to_speak: text })
            });
            const data = await response.json();
            if (data.audio) {
                const audioBlob = new Blob([Uint8Array.from(atob(data.audio), c => c.charCodeAt(0))], {type: 'audio/mp3'});
                const arrayBuffer = await audioBlob.arrayBuffer();
                const decodedBuffer = await audioContext.decodeAudioData(arrayBuffer);
                const source = audioContext.createBufferSource();
                source.buffer = decodedBuffer;
                source.connect(audioContext.destination);
                source.start(0);
            }
        };

        initialize();
    });
    </script>
</body>
</html>