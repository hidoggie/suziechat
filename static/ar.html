<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        .ar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; pointer-events: none;}
        .ar-button { padding: 10px 20px; font-size: 1.2em; border-radius: 5px; border: none; background-color: rgba(0,0,0,0.6); color: white; cursor: pointer; pointer-events: all; }
        #ar-description-box { background-color: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 10px; max-height: 40%; overflow-y: auto; pointer-events: all; margin: 0 auto 20px auto; max-width: 90%; }
        .hidden { display: none; }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-size: 1.5em; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <a-scene id="ar-scene" mindar-image="imageTargetSrc: /static/targets.mind; autoStart: false;" 
             color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        </a-scene>

    <div class="ar-overlay">
        <div id="loading-overlay">
            <div class="spinner"></div>
            <p style="margin-top: 20px;">AR ì—”ì§„ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
        <div></div> <div id="ar-description-box" class="hidden">
            <p id="ar-text"></p>
            <button id="ar-tts-btn" class="ar-button" style="margin-top: 10px; width: 100%;">ğŸ”Š ìŒì„± ì•ˆë‚´</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const sceneEl = document.querySelector('a-scene');
        const descriptionBox = document.getElementById('ar-description-box');
        const arText = document.getElementById('ar-text');
        const arTtsBtn = document.getElementById('ar-tts-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        let pdfContent = [];
        let audioContext;

        try {
            // âœ¨ 2. AR ì—”ì§„ ì‹œì‘ ì „ì— ëª¨ë“  ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
            const response = await fetch('/api/pdf-content');
            pdfContent = await response.json();

            // âœ¨ 3. ì¸ì‹í•  ì´ë¯¸ì§€ íƒ€ê²Ÿì„ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
            const allImages = pdfContent.flatMap(p => p.images);
            allImages.forEach((imageName, index) => {
                const entity = document.createElement('a-entity');
                // ê° íƒ€ê²Ÿì— ê³ ìœ í•œ íŒŒì¼ ì´ë¦„ì„ data ì†ì„±ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤. (ìˆœì„œ ë¬¸ì œ í•´ê²°)
                entity.setAttribute('mindar-image-target', `targetIndex: ${index}`);
                entity.setAttribute('data-image-name', imageName); 
                sceneEl.appendChild(entity);
            });

            // âœ¨ 4. 'targetFound'ì™€ 'targetLost' ì´ë²¤íŠ¸ë¥¼ ê° íƒ€ê²Ÿ ì—”í‹°í‹°ì— ì§ì ‘ ì—°ê²°í•©ë‹ˆë‹¤.
            const targetEntities = document.querySelectorAll('[mindar-image-target]');
            targetEntities.forEach(target => {
                target.addEventListener("targetfound", event => {
                    const foundImageName = event.target.getAttribute('data-image-name');
                    if (foundImageName) {
                        const page = pdfContent.find(p => p.images.includes(foundImageName));
                        if (page) {
                            arText.textContent = page.text;
                            descriptionBox.classList.remove('hidden');
                        }
                    }
                });
                target.addEventListener("targetlost", event => {
                    descriptionBox.classList.add('hidden');
                });
            });

            // âœ¨ 5. ëª¨ë“  ì¤€ë¹„ê°€ ëë‚œ í›„, AR ì‹œìŠ¤í…œì„ ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.
            const arSystem = sceneEl.systems['mindar-image-system'];
            sceneEl.addEventListener('arready', () => {
                loadingOverlay.classList.add('hidden'); // ARì´ ì¤€ë¹„ë˜ë©´ ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
            });
            await arSystem.start();

        } catch (e) {
            loadingOverlay.classList.add('hidden');
            console.error("AR ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
            alert("AR ê¸°ëŠ¥ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜, ì±—ë´‡ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì£¼ì„¸ìš”.");
        }

        arTtsBtn.onclick = async () => {
            const text = arText.textContent;
            if (!text) return;
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();

            const response = await fetch('/api/tts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text_to_speak: text })
            });
            const data = await response.json();
            if (data.audio) {
                const audioBlob = new Blob([Uint8Array.from(atob(data.audio), c => c.charCodeAt(0))], {type: 'audio/mp3'});
                const arrayBuffer = await audioBlob.arrayBuffer();
                const decodedBuffer = await audioContext.decodeAudioData(arrayBuffer);
                const source = audioContext.createBufferSource();
                source.buffer = decodedBuffer;
                source.connect(audioContext.destination);
                source.start(0);
            }
        };

//        initialize();
    });
    </script>
</body>
</html>
