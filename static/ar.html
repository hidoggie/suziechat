<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        .ar-overlay { position: fixed; bottom: 0; left: 0; right: 0; z-index: 10; padding: 20px; box-sizing: border-box; pointer-events: none; }
        .ar-button { padding: 10px 20px; font-size: 1.2em; border-radius: 5px; border: none; background-color: rgba(0,0,0,0.6); color: white; cursor: pointer; pointer-events: all; }
        #ar-description-box { background-color: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 10px; max-height: 40vh; overflow-y: auto; pointer-events: all; margin: 0 auto 20px auto; max-width: 90%; }
        .hidden { display: none; }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene
        id="ar-scene"
        vr-mode-ui="enabled: false;"
        renderer="logarithmicDepthBuffer: true; antialias: true; colorManagement: true;"        
        arjs="sourceType: webcam; debugUIEnabled: false;">
        
        <a-nft
            id="image-marker"
            type="nft"
            url="/static/markers/target1/page_10_img_0"
            smooth="true"
            smoothCount="10"
            smoothTolerance=".01"
            smoothThreshold="5">
            </a-nft>

        <a-entity camera></a-entity>
    </a-scene>

    <div class="ar-overlay">
        <div id="ar-description-box" class="hidden">
            <p id="ar-text"></p>
            <button id="ar-tts-btn" class="ar-button" style="margin-top: 10px; width: 100%;">ğŸ”Š ìŒì„± ì•ˆë‚´</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const sceneEl = document.querySelector("#ar-scene");
        const marker = document.querySelector("#image-marker");
        const descriptionBox = document.getElementById('ar-description-box');
        const arText = document.getElementById('ar-text');
        const arTtsBtn = document.getElementById('ar-tts-btn');
        let contentMap = {};
        
        try {
            const response = await fetch('/api/pdf-content');
            contentMap = await response.json();
        } catch(e) {
            alert('ì»¨í…ì¸  ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        // 4. ë§ˆì»¤(ì´ë¯¸ì§€)ê°€ ì°¾ì•„ì¡Œì„ ë•Œ ì‹¤í–‰ë  ë¡œì§
        marker.addEventListener('markerFound', () => {
            console.log("Marker Found!");
            // ì´ ì˜ˆì œì—ì„œëŠ” ì²«ë²ˆì§¸ ì´ë¯¸ì§€(page_10_img_0.png)ì— ëŒ€í•œ ì„¤ëª…ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
            const targetImageName = "page_10_img_0.png"; // ë§ˆì»¤ë¥¼ ìƒì„±í•œ ì´ë¯¸ì§€ íŒŒì¼ ì´ë¦„
            const textToShow = contentMap[targetImageName];

            if (textToShow) {
                arText.textContent = textToShow;
                descriptionBox.classList.remove('hidden');
            }
        });

        // 5. ë§ˆì»¤(ì´ë¯¸ì§€)ë¥¼ ìƒì–´ë²„ë ¸ì„ ë•Œ ì‹¤í–‰ë  ë¡œì§
        marker.addEventListener('markerLost', () => {
            console.log("Marker Lost!");
            descriptionBox.classList.add('hidden');
        });
        
        // âœ¨ 6. ì¤Œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ìµœì¢… ì½”ë“œ âœ¨
        // AR.jsê°€ ì™„ì „íˆ ë¡œë“œëœ í›„, í™”ë©´ í¬ê¸°ë¥¼ ê°•ì œë¡œ ì¬ì¡°ì •í•©ë‹ˆë‹¤.
        sceneEl.addEventListener('loaded', () => {
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
                console.log("Forcing resize to fix camera zoom.");
            }, 500);
        });
        
         // âœ¨ ìŒì„± ì•ˆë‚´ ë²„íŠ¼ì€ ì¤€ë¹„ëœ ì˜¤ë””ì˜¤ë¥¼ ì¬ìƒë§Œ í•˜ë„ë¡ ìˆ˜ì •
    arTtsBtn.onclick = async () => {
    const text = arText.textContent;
    if (!text) return;

    // UI í”¼ë“œë°±: ë²„íŠ¼ì„ ë¹„í™œì„±í™”í•˜ê³  ë¡œë”© ìƒíƒœë¡œ ë³€ê²½
    arTtsBtn.disabled = true;
    arTtsBtn.textContent = "ğŸ”Š ìƒì„± ì¤‘...";

    try {
        // 1. í™”ë©´ì˜ í…ìŠ¤íŠ¸ë¥¼ ë°±ì—”ë“œì˜ /api/tts ì—”ë“œí¬ì¸íŠ¸ë¡œ ì „ì†¡
        const response = await fetch('/api/tts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text_to_speak: text })
        });

        if (!response.ok) {
            throw new Error(`ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        }
        
        const data = await response.json();

        if (data.audio) {
            // 2. ë°›ì€ Base64 ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ë””ì½”ë”©í•˜ê³  Web Audio APIë¡œ ì¬ìƒ (iOS í˜¸í™˜)
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();

            // atob()ëŠ” Base64 ë¬¸ìì—´ì„ ë””ì½”ë”©í•©ë‹ˆë‹¤.
            const audioBlob = new Blob([Uint8Array.from(atob(data.audio), c => c.charCodeAt(0))], {type: 'audio/mp3'});
            const arrayBuffer = await audioBlob.arrayBuffer();
            const decodedBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            const source = audioContext.createBufferSource();
            source.buffer = decodedBuffer;
            source.connect(audioContext.destination);
            source.start(0);

            // ì¬ìƒì´ ëë‚˜ë©´ ë²„íŠ¼ì„ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
            source.onended = () => {
                arTtsBtn.disabled = false;
                arTtsBtn.textContent = "ğŸ”Š ìŒì„± ì•ˆë‚´";
            };

        } else {
            throw new Error(data.error || "ì„œë²„ë¡œë¶€í„° ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    } catch (e) {
        console.error("TTS ì˜¤ë¥˜:", e);
        alert("ìŒì„±ì„ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ë²„íŠ¼ì„ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
        arTtsBtn.disabled = false;
        arTtsBtn.textContent = "ğŸ”Š ìŒì„± ì•ˆë‚´";
    }
};

    });
    </script>
</body>
</html>                              
