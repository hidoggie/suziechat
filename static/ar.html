<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; }
        #ar-container { position: relative; width: 100%; height: 100%; }
        .ar-overlay { position: fixed; bottom: 0; left: 0; right: 0; z-index: 10; padding: 20px; box-sizing: border-box; pointer-events: none; }
        .ar-button { padding: 10px 20px; font-size: 1.2em; border-radius: 5px; border: none; background-color: rgba(0,0,0,0.6); color: white; cursor: pointer; pointer-events: all; }
        #ar-description-box { background-color: rgba(0,0,0,0.7); color: white; padding: 15px; border-radius: 10px; max-height: 40vh; overflow-y: auto; pointer-events: all; margin: 0 auto 20px auto; max-width: 90%; }
        .hidden { display: none; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; font-size: 1.5em; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="ar-container">
        <div class="ar-overlay">
            <div id="loading-overlay">
                <div class="spinner"></div>
                <p style="margin-top: 20px;">AR ì—”ì§„ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
            <div id="ar-description-box" class="hidden">
                <p id="ar-text"></p>
                <button id="ar-tts-btn" class="ar-button" style="margin-top: 10px; width: 100%;">ğŸ”Š ìŒì„± ì•ˆë‚´</button>
            </div>
        </div>
    </div>

    <script type="module">
    // âœ¨ 3. MindAR ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì§ì ‘ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½
    document.addEventListener('DOMContentLoaded', async () => {
        const descriptionBox = document.getElementById('ar-description-box');
        const arText = document.getElementById('ar-text');
        const arTtsBtn = document.getElementById('ar-tts-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        let pdfContent = [];
        let audioContext;

        try {
            const response = await fetch('/api/pdf-content');
            pdfContent = await response.json();
            const allImages = pdfContent.flatMap(p => p.images);

            const mindarThree = new MINDAR.IMAGE.MindARThree({
                container: document.querySelector("#ar-container"),
                imageTargetSrc: "static/targets.mind",
            });
            const {renderer, scene, camera} = mindarThree;

            // âœ¨ 4. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ mindarThree ê°ì²´ì— ì§ì ‘ ì—°ê²° (ê°€ì¥ ì•ˆì •ì ì¸ ë°©ì‹)
            mindarThree.on("targetFound", event => {
                const targetIndex = event.target.index;
                const foundImageName = allImages[targetIndex];
                if (foundImageName) {
                    const page = pdfContent.find(p => p.images.includes(foundImageName));
                    if (page) {
                        arText.textContent = page.text;
                        descriptionBox.classList.remove('hidden');
                    }
                }
            });

            mindarThree.on("targetLost", event => {
                descriptionBox.classList.add('hidden');
            });

            // ë Œë”ë§ ì‹œì‘
            await mindarThree.start();
            loadingOverlay.classList.add('hidden'); // ì‹œì‘ì´ ì„±ê³µí•˜ë©´ ë¡œë”© í™”ë©´ ìˆ¨ê¸°ê¸°
            
            renderer.setAnimationLoop(() => {
                renderer.render(scene, camera);
            });

        } catch (e) {
            loadingOverlay.classList.add('hidden');
            console.error("AR ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
            alert("AR ê¸°ëŠ¥ì„ ì‹œì‘í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•˜ê³  ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
        }
        
         // âœ¨ ìŒì„± ì•ˆë‚´ ë²„íŠ¼ì€ ì¤€ë¹„ëœ ì˜¤ë””ì˜¤ë¥¼ ì¬ìƒë§Œ í•˜ë„ë¡ ìˆ˜ì •
   arTtsBtn.onclick = async () => {
    const text = arText.textContent;
    if (!text) return;

    arTtsBtn.disabled = true;
    arTtsBtn.textContent = "ğŸ”Š ìƒì„± ì¤‘...";

    try {
        const response = await fetch('/api/tts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // FastAPIê°€ embed=Trueë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, í•œ ë²ˆ ë” ê°ì‹¸ì„œ ë³´ëƒ…ë‹ˆë‹¤.
            body: JSON.stringify({ "text_to_speak": text })
        });

        if (!response.ok) {
            // ì„œë²„ê°€ 500 ì˜¤ë¥˜ ë“±ì„ ë°˜í™˜í–ˆì„ ë•Œ ì²˜ë¦¬
            const errorData = await response.json();
            throw new Error(errorData.detail || `ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);
        }
        
        const data = await response.json();

        if (data.audio) {
            if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();

            const arrayBuffer = Uint8Array.from(atob(data.audio), c => c.charCodeAt(0)).buffer;
            const decodedBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            const source = audioContext.createBufferSource();
            source.buffer = decodedBuffer;
            source.connect(audioContext.destination);
            source.start(0);

            source.onended = () => {
                arTtsBtn.disabled = false;
                arTtsBtn.textContent = "ğŸ”Š ìŒì„± ì•ˆë‚´";
            };
        } else {
            throw new Error("ì„œë²„ë¡œë¶€í„° ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    } catch (e) {
        console.error("TTS ì˜¤ë¥˜:", e);
        alert(`ìŒì„±ì„ ìƒì„±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${e.message}`);
        arTtsBtn.disabled = false;
        arTtsBtn.textContent = "ğŸ”Š ìŒì„± ì•ˆë‚´";
    }
};

    });
    </script>
</body>
</html>                              